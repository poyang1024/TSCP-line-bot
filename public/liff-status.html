<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>會員狀態檢查中...</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: #f5f5f5;
        }
        .loading {
            text-align: center;
            color: #666;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loading">
        <div class="spinner"></div>
        <p id="status">檢查登入狀態中...</p>
        <div id="debug" style="font-size: 12px; color: #999; margin-top: 10px; text-align: left; display: none;"></div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // 除錯輔助函數
        function debug(message) {
            console.log(message);
            const debugDiv = document.getElementById('debug');
            debugDiv.style.display = 'block';
            debugDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
        }
        
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            debug('狀態更新: ' + message);
        }
        
        // 從 URL 參數取得資訊
        const urlParams = new URLSearchParams(window.location.search);
        const action = urlParams.get('action') || 'member_center';
        const userId = urlParams.get('userId');
        
        debug('URL 參數: action=' + action + ', userId=' + userId);
        debug('當前 URL: ' + window.location.href);
        
        // 顯示本地儲存狀態
        debug('localStorage 項目數: ' + localStorage.length);
        debug('jwt_token: ' + (localStorage.getItem('jwt_token') ? '存在' : '不存在'));
        debug('jwt_expires: ' + localStorage.getItem('jwt_expires'));
        
        // 初始化 LIFF
        // 當透過 line://app/LIFF-ID 開啟時，LIFF ID 會自動處理
        // 不需要手動指定 liffId 參數
        
        updateStatus('正在初始化 LIFF...');
        debug('開始 LIFF 初始化...');
        
        // 從 API 取得 LIFF ID
        try {
            const configResponse = await fetch('/api/config');
            const config = await configResponse.json();
            const liffId = config.liffId;
            
            debug('從 API 取得 LIFF ID: ' + liffId);
            
            if (!liffId) {
                throw new Error('LIFF ID 未設定');
            }
            
            // 添加超時處理
            const timeout = setTimeout(() => {
                debug('LIFF 初始化超時 (10秒)');
                updateStatus('初始化超時，請重新嘗試');
            }, 10000);
            
            // 使用從 API 取得的 LIFF ID 進行初始化
            liff.init({ liffId: liffId }).then(() => {
            clearTimeout(timeout);
            debug('LIFF 初始化成功');
            updateStatus('檢查認證狀態...');
            
            // 檢查 localStorage 中的 JWT token
            const token = localStorage.getItem('jwt_token');
            const expires = localStorage.getItem('jwt_expires');
            
            debug('Token 檢查: hasToken=' + !!token + ', expires=' + expires + ', isValid=' + (token && expires && Date.now() < parseInt(expires)));
            
            if (token && expires && Date.now() < parseInt(expires)) {
                // Token 有效，發送隱藏訊息給 Bot
                updateStatus('發送認證資訊...');
                const message = `jwt_action:${action}:${token}`;
                debug('發送訊息: ' + message.substring(0, 50) + '...');
                
                liff.sendMessages([{
                    type: 'text',
                    text: message
                }]).then(() => {
                    debug('訊息發送成功');
                    updateStatus('處理完成');
                    setTimeout(() => {
                        liff.closeWindow();
                    }, 1000);
                }).catch(err => {
                    debug('發送訊息失敗: ' + err.message);
                    updateStatus('發送失敗，重新登入');
                    // 發送登入過期訊息
                    liff.sendMessages([{
                        type: 'text',
                        text: 'login_expired'
                    }]).then(() => {
                        liff.closeWindow();
                    });
                });
            } else {
                // Token 無效或過期
                debug('Token 無效或過期');
                updateStatus('認證過期，重新登入');
                liff.sendMessages([{
                    type: 'text',
                    text: 'login_expired'
                }]).then(() => {
                    liff.closeWindow();
                });
            }
        }).catch(err => {
            debug('LIFF 初始化失敗: ' + err.message);
            updateStatus('初始化失敗，請重新嘗試');
            
            // 回退到一般登入流程
            setTimeout(() => {
                if (userId) {
                    debug('重導向到登入頁面 (錯誤回退)');
                    window.location.href = `/auth/login?userId=${userId}`;
                } else {
                    // 如果沒有 userId，嘗試關閉視窗
                    try {
                        liff.closeWindow();
                    } catch (e) {
                        // 如果關閉失敗，顯示提示
                        updateStatus('請關閉此頁面');
                    }
                }
            }, 2000);
        });
        
        } catch (configErr) {
            debug('取得配置失敗: ' + configErr.message);
            updateStatus('配置載入失敗，請重新嘗試');
        }
    </script>
</body>
</html>
