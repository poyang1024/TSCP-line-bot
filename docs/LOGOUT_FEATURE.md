# 登出功能說明

## ✅ 已實現登出功能

### 🚀 如何使用登出功能

#### 方法 1：文字指令
用戶可以輸入以下任何一個指令來登出：
- `登出`
- `會員登出`

#### 方法 2：主選單按鈕
在已登入狀態下：
1. 輸入 `選單` 或 `主選單`
2. 點選 `🔓 會員登出` 按鈕

### 🔧 登出功能詳情

#### 登出時會執行以下操作：
1. **清除 Redis 登入狀態** - 移除持久化的登入資料
2. **清除記憶體狀態** - 移除暫存的用戶資料
3. **清除 JWT Cookie** - 移除客戶端的認證 token
4. **切換到訪客選單** - 自動切換 Rich Menu
5. **顯示登出成功訊息** - 確認登出完成

#### 狀態檢查：
- ✅ **已登入用戶**：執行完整登出流程ㄦ
- ⚠️ **未登入用戶**：顯示「您尚未登入，無需登出」

### 📱 用戶體驗流程

```
用戶輸入「登出」
     ↓
檢查登入狀態
     ↓
[已登入] → 清除 Redis 狀態 → 清除記憶體 → 清除 JWT → 切換選單 → 顯示成功訊息
[未登入] → 顯示「無需登出」訊息
```

### 🎯 改進的主選單

新的主選單現在使用 **Flex Message** 格式，包含：
- 🔍 搜尋藥局
- 📋 我的訂單  
- 📷 上傳藥單
- 🔓 會員登出 ← **新增**

### 🔒 安全性

- 登出時會清除 Redis 中的登入狀態（跨實例生效）
- 清除記憶體中的敏感資料（memberId, accessToken）
- 清除 JWT Cookie 防止重複使用
- 防止未登入用戶的無效操作

### 🧪 測試建議

1. **登入後登出測試**：
   ```
   輸入「登入」→ 完成登入 → 輸入「登出」→ 確認清除狀態
   ```

2. **未登入登出測試**：
   ```
   確保未登入 → 輸入「登出」→ 確認顯示適當訊息
   ```

3. **主選單登出測試**：
   ```
   登入 → 輸入「選單」→ 點選登出按鈕 → 確認執行登出
   ```

### 💡 技術實現

#### 相關文件：
- `src/handlers/messageHandler.ts` - 處理登出指令
- `src/services/userService.ts` - 執行登出邏輯
- `src/templates/messageTemplates.ts` - 主選單添加登出按鈕

#### 函數調用鏈：
```
messageHandler.handleMessage()
    ↓
redisService.deleteUserLoginState()  // 清除 Redis
    ↓
userService.clearUserState()         // 清除記憶體
    ↓
menuManager.switchToGuestMenu()      // 切換選單
```

現在用戶可以隨時安全地登出系統！🎉
