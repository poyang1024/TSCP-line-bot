# LINE Bot åœ–æ–‡é¸å–® (Rich Menu) è¨­å®šå®Œæ•´æŒ‡å—

## ğŸ“‹ ç›®éŒ„
- [ç³»çµ±æ¦‚è¿°](#ç³»çµ±æ¦‚è¿°)
- [åœ–æ–‡é¸å–®æ¶æ§‹](#åœ–æ–‡é¸å–®æ¶æ§‹)
- [å‰ç½®æº–å‚™](#å‰ç½®æº–å‚™)
- [è¨­å®šæ­¥é©Ÿ](#è¨­å®šæ­¥é©Ÿ)
- [åœ–ç‰‡è£½ä½œè¦ç¯„](#åœ–ç‰‡è£½ä½œè¦ç¯„)
- [é¸å–®é…ç½®èªªæ˜](#é¸å–®é…ç½®èªªæ˜)
- [ç–‘é›£æ’è§£](#ç–‘é›£æ’è§£)
- [é€²éšç®¡ç†](#é€²éšç®¡ç†)

---

## ğŸ¯ ç³»çµ±æ¦‚è¿°

TSCP LINE Bot ä½¿ç”¨ä¸‰ç¨®åœ–æ–‡é¸å–®ä¾†æä¾›ä¸åŒçš„ä½¿ç”¨è€…é«”é©—ï¼š

| é¸å–®é¡å‹ | ç”¨é€” | é¡¯ç¤ºæ™‚æ©Ÿ |
|---------|------|---------|
| **è¨ªå®¢é¸å–®** | æœªç™»å…¥ç”¨æˆ¶ä½¿ç”¨ | ç”¨æˆ¶é¦–æ¬¡åŠ å…¥ Bot æˆ–ç™»å‡ºå¾Œ |
| **æœƒå“¡é¸å–®** | å·²ç™»å…¥æœƒå“¡ä½¿ç”¨ | ç”¨æˆ¶ç™»å…¥æˆåŠŸå¾Œ |
| **Loading é¸å–®** | è™•ç†ä¸­ç‹€æ…‹é¡¯ç¤º | åŸ·è¡Œè€—æ™‚æ“ä½œæ™‚ï¼ˆæŸ¥è©¢è¨‚å–®ã€è¼‰å…¥è³‡æ–™ç­‰ï¼‰ |

### ç³»çµ±ç‰¹è‰²
âœ… **è‡ªå‹•åˆ‡æ›** - æ ¹æ“šç™»å…¥ç‹€æ…‹è‡ªå‹•åˆ‡æ›é¸å–®  
âœ… **Loading å›é¥‹** - è™•ç†è«‹æ±‚æ™‚é¡¯ç¤ºè™•ç†ä¸­ç‹€æ…‹  
âœ… **æ¸›å°‘ API èª¿ç”¨** - ä½¿ç”¨ Rich Menu åˆ‡æ›ä»£æ›¿ pushMessage  
âœ… **è‰¯å¥½ UX** - æä¾›å³æ™‚è¦–è¦ºå›é¥‹

---

## ğŸ—ï¸ åœ–æ–‡é¸å–®æ¶æ§‹

### 1. è¨ªå®¢é¸å–® (Guest Rich Menu)

![è¨ªå®¢é¸å–®](../public/guest_richmenu.png)

**åŠŸèƒ½èªªæ˜ï¼š**
- **ä¸Šæ–¹å€åŸŸ**ï¼šä¸­è—¥é ç´„ï¼ˆé»æ“Šå¾Œæç¤ºéœ€è¦ç™»å…¥ï¼‰
- **å·¦ä¸‹å€åŸŸ**ï¼šè—¥å¸«è«®è©¢ï¼ˆé–‹æ”¾åŠŸèƒ½ï¼Œå¯ç›´æ¥ä½¿ç”¨ï¼‰
- **ä¸­ä¸‹å€åŸŸ**ï¼šä¸­è—¥æ–°çŸ¥ï¼ˆè¡›æ•™è³‡è¨Šï¼‰
- **å³ä¸‹å€åŸŸ**ï¼šäº†è§£æ›´å¤šï¼ˆä½¿ç”¨æ•™å­¸ï¼‰

---

### 2. æœƒå“¡é¸å–® (Member Rich Menu)

![æœƒå“¡é¸å–®](../public/member_richmenu.png)

**åŠŸèƒ½èªªæ˜ï¼š**
- **å·¦ä¸Šå€åŸŸ**ï¼šæ–°å¢è¨‚å–®ï¼ˆå»ºç«‹æ–°çš„ä¸­è—¥é ç´„ï¼‰
- **ä¸­ä¸Šå€åŸŸ**ï¼šæœƒå“¡ä¸­å¿ƒï¼ˆå€‹äººè³‡æ–™ã€ç™»å‡ºç­‰ï¼‰
- **å³ä¸Šå€åŸŸ**ï¼šæˆ‘çš„è¨‚å–®ï¼ˆæŸ¥çœ‹è¨‚å–®åˆ—è¡¨ï¼‰
- **ä¸‹æ–¹ä¸‰å€åŸŸ**ï¼šèˆ‡è¨ªå®¢é¸å–®ç›¸åŒ

---

### 3. Loading é¸å–® (Loading Rich Menu)

![Loading é¸å–®](../public/loading_richmenu.png)

**åŠŸèƒ½èªªæ˜ï¼š**
- æ•´å€‹å€åŸŸé¡¯ç¤ºè™•ç†ä¸­è¨Šæ¯
- é»æ“Šæ™‚é¡¯ç¤ºã€ŒLoading ...ã€
- è™•ç†å®Œæˆå¾Œè‡ªå‹•åˆ‡æ›å›åŸé¸å–®

---

## ğŸ“‹ å‰ç½®æº–å‚™

### 1. ç¢ºèªç’°å¢ƒè¨­å®š

ç¢ºèª `.env` æª”æ¡ˆä¸­æœ‰ä»¥ä¸‹è¨­å®šï¼š

```env
LINE_CHANNEL_ACCESS_TOKEN=your_channel_access_token
LINE_CHANNEL_SECRET=your_channel_secret
```

### 2. æº–å‚™åœ–ç‰‡æª”æ¡ˆ

åœ¨ `public/` è³‡æ–™å¤¾ä¸­æº–å‚™ä»¥ä¸‹åœ–ç‰‡ï¼š

```
public/
â”œâ”€â”€ guest_richmenu.png      # è¨ªå®¢é¸å–®åœ–ç‰‡ (2500x1686)
â”œâ”€â”€ member_richmenu.png     # æœƒå“¡é¸å–®åœ–ç‰‡ (2500x1686)
â””â”€â”€ loading_richmenu.png    # Loading é¸å–®åœ–ç‰‡ (2500x1686)
```

**âš ï¸ åœ–ç‰‡è¦ç¯„ï¼š**
- **å°ºå¯¸**ï¼šå¿…é ˆæ˜¯ `2500 x 1686` åƒç´ 
- **æ ¼å¼**ï¼šæ”¯æ´ PNG æˆ– JPG
- **æª”æ¡ˆå¤§å°**ï¼šå»ºè­°å°æ–¼ 1MB
- **è¨­è¨ˆå»ºè­°**ï¼šæ¸…æ™°çš„å€åŸŸåŠƒåˆ†ã€æ˜“æ–¼ç†è§£çš„åœ–ç¤º

### 3. å®‰è£ç›¸ä¾å¥—ä»¶

ç¢ºèªå·²å®‰è£æ‰€éœ€çš„ npm å¥—ä»¶ï¼š

```bash
npm install
```

---

## ğŸš€ è¨­å®šæ­¥é©Ÿ

### æ–¹æ³•ä¸€ï¼šå¿«é€Ÿè‡ªå‹•è¨­å®šï¼ˆæ¨è–¦ï¼‰

é€™æ˜¯æœ€ç°¡å–®çš„æ–¹æ³•ï¼Œä¸€æ¬¡å»ºç«‹æ‰€æœ‰åœ–æ–‡é¸å–®ã€‚

#### æ­¥é©Ÿ 1ï¼šåŸ·è¡Œè¨­å®šè…³æœ¬

```bash
npm run setup-menus
```

æˆ–

```bash
node scripts/setup-rich-menus.js
```

#### æ­¥é©Ÿ 2ï¼šæŸ¥çœ‹è¼¸å‡ºçµæœ

è…³æœ¬åŸ·è¡Œå®Œæˆå¾Œæœƒé¡¯ç¤ºï¼š

```
ğŸ‰ åœ–æ–‡é¸å–®å»ºç«‹å®Œæˆï¼

ğŸ“ è«‹å°‡ä»¥ä¸‹å…§å®¹åŠ å…¥ä½ çš„ .env æª”æ¡ˆ:
==================================================
GUEST_RICH_MENU_ID=richmenu-abc123...
MEMBER_RICH_MENU_ID=richmenu-def456...
LOADING_RICH_MENU_ID=richmenu-ghi789...
==================================================

âœ… å®Œæˆï¼ç¾åœ¨ä½ å¯ä»¥é‡æ–°å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ä¾†ä½¿ç”¨æ–°çš„åœ–æ–‡é¸å–®ã€‚
```

#### æ­¥é©Ÿ 3ï¼šæ›´æ–° .env æª”æ¡ˆ

å°‡è¼¸å‡ºçš„ Rich Menu ID åŠ å…¥ `.env` æª”æ¡ˆï¼š

```env
# LINE Bot è¨­å®š
LINE_CHANNEL_ACCESS_TOKEN=your_token_here
LINE_CHANNEL_SECRET=your_secret_here

# Rich Menu IDs
GUEST_RICH_MENU_ID=richmenu-abc123...
MEMBER_RICH_MENU_ID=richmenu-def456...
LOADING_RICH_MENU_ID=richmenu-ghi789...
```

#### æ­¥é©Ÿ 4ï¼šé‡æ–°å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼

```bash
# æœ¬åœ°é–‹ç™¼
npm run dev

# ç”Ÿç”¢ç’°å¢ƒ
npm start
```

#### æ­¥é©Ÿ 5ï¼šæ¸¬è©¦åŠŸèƒ½

1. åœ¨ LINE ä¸­æ‰“é–‹ä½ çš„ Bot
2. ç¢ºèªçœ‹åˆ°åœ–æ–‡é¸å–®ï¼ˆä¸‹æ–¹åŠŸèƒ½æ¬„ï¼‰
3. é»æ“Šå„å€‹æŒ‰éˆ•æ¸¬è©¦åŠŸèƒ½
4. å˜—è©¦ç™»å…¥/ç™»å‡ºï¼Œç¢ºèªé¸å–®æœƒåˆ‡æ›

---

### æ–¹æ³•äºŒï¼šäº’å‹•å¼ç®¡ç†ï¼ˆé€²éšï¼‰

ä½¿ç”¨äº’å‹•å¼å·¥å…·å¯ä»¥æ›´éˆæ´»åœ°ç®¡ç†åœ–æ–‡é¸å–®ã€‚

#### å•Ÿå‹•ç®¡ç†å·¥å…·

```bash
npm run manage-menus
```

æˆ–

```bash
node scripts/manage-rich-menus.js
```

#### ç®¡ç†é¸å–®æ“ä½œ

```
ğŸ¨ LINE Bot åœ–æ–‡é¸å–®ç®¡ç†å·¥å…·

è«‹é¸æ“‡æ“ä½œï¼š
1. åˆ—å‡ºç¾æœ‰åœ–æ–‡é¸å–®
2. å»ºç«‹æ–°çš„åœ–æ–‡é¸å–®
3. åˆªé™¤æŒ‡å®šåœ–æ–‡é¸å–®
4. å»ºç«‹å®Œæ•´çš„é¸å–®çµ„åˆï¼ˆè¨ªå®¢+æœƒå“¡+Loadingï¼‰
5. é€€å‡º

è«‹è¼¸å…¥é¸é … (1-5):
```

**åŠŸèƒ½èªªæ˜ï¼š**

| é¸é … | åŠŸèƒ½ | ä½¿ç”¨æ™‚æ©Ÿ |
|------|------|---------|
| **1** | åˆ—å‡ºç¾æœ‰é¸å–® | æŸ¥çœ‹ç›®å‰å·²å»ºç«‹çš„æ‰€æœ‰åœ–æ–‡é¸å–® |
| **2** | å»ºç«‹æ–°é¸å–® | å–®ç¨å»ºç«‹è¨ªå®¢ã€æœƒå“¡æˆ– Loading é¸å–® |
| **3** | åˆªé™¤é¸å–® | æ¸…ç†ä¸éœ€è¦çš„èˆŠé¸å–® |
| **4** | å»ºç«‹å®Œæ•´çµ„åˆ | ä¸€æ¬¡å»ºç«‹æ‰€æœ‰ä¸‰ç¨®é¸å–® |
| **5** | é€€å‡ºç¨‹å¼ | çµæŸç®¡ç†å·¥å…· |

#### ç¯„ä¾‹ï¼šå»ºç«‹å®Œæ•´é¸å–®çµ„åˆ

```bash
$ npm run manage-menus

è«‹é¸æ“‡æ“ä½œï¼š
> 4

ğŸ¨ å»ºç«‹å®Œæ•´çš„é¸å–®çµ„åˆ...

ğŸ¨ å»ºç«‹è¨ªå®¢åœ–æ–‡é¸å–®...
âœ… è¨ªå®¢åœ–æ–‡é¸å–®å»ºç«‹æˆåŠŸï¼ŒID: richmenu-abc...
âœ… è¨ªå®¢åœ–æ–‡é¸å–®åœ–ç‰‡ä¸Šå‚³æˆåŠŸ

ğŸ¨ å»ºç«‹æœƒå“¡åœ–æ–‡é¸å–®...
âœ… æœƒå“¡åœ–æ–‡é¸å–®å»ºç«‹æˆåŠŸï¼ŒID: richmenu-def...
âœ… æœƒå“¡åœ–æ–‡é¸å–®åœ–ç‰‡ä¸Šå‚³æˆåŠŸ

ğŸ¨ å»ºç«‹ Loading ç‹€æ…‹åœ–æ–‡é¸å–®...
âœ… Loading åœ–æ–‡é¸å–®å»ºç«‹æˆåŠŸï¼ŒID: richmenu-ghi...
âœ… Loading åœ–æ–‡é¸å–®åœ–ç‰‡ä¸Šå‚³æˆåŠŸ

ğŸ‰ å®Œæ•´é¸å–®çµ„åˆå»ºç«‹æˆåŠŸï¼

ğŸ“ è«‹å°‡ä»¥ä¸‹å…§å®¹åŠ å…¥ .env æª”æ¡ˆ:
==================================================
GUEST_RICH_MENU_ID=richmenu-abc...
MEMBER_RICH_MENU_ID=richmenu-def...
LOADING_RICH_MENU_ID=richmenu-ghi...
==================================================

æ˜¯å¦è¦è‡ªå‹•å¯«å…¥ .env æª”æ¡ˆï¼Ÿ (y/N): y
âœ… .env æª”æ¡ˆæ›´æ–°æˆåŠŸï¼
```

---

### æ–¹æ³•ä¸‰ï¼šå–®ç¨å»ºç«‹ Loading é¸å–®

å¦‚æœåªéœ€è¦å»ºç«‹æˆ–æ›´æ–° Loading é¸å–®ï¼š

```bash
node scripts/setup-loading-menu.js
```

---

## ğŸ¨ åœ–ç‰‡è£½ä½œè¦ç¯„

### å°ºå¯¸è¦æ±‚

**æ‰€æœ‰åœ–æ–‡é¸å–®åœ–ç‰‡å¿…é ˆæ˜¯ `2500 x 1686` åƒç´ **

### å€åŸŸåº§æ¨™è¨ˆç®—

åœ–æ–‡é¸å–®çš„å¯é»æ“Šå€åŸŸä½¿ç”¨åº§æ¨™å®šç¾©ï¼š

```javascript
{
  bounds: { 
    x: èµ·å§‹Xåº§æ¨™, 
    y: èµ·å§‹Yåº§æ¨™, 
    width: å¯¬åº¦, 
    height: é«˜åº¦ 
  }
}
```

#### è¨ªå®¢é¸å–®å€åŸŸé…ç½®

```
ä¸Šæ–¹å€åŸŸï¼ˆä¸­è—¥é ç´„ï¼‰ï¼š
  x: 0, y: 0, width: 2500, height: 843

å·¦ä¸‹å€åŸŸï¼ˆè—¥å¸«è«®è©¢ï¼‰ï¼š
  x: 0, y: 843, width: 833, height: 843

ä¸­ä¸‹å€åŸŸï¼ˆä¸­è—¥æ–°çŸ¥ï¼‰ï¼š
  x: 833, y: 843, width: 834, height: 843

å³ä¸‹å€åŸŸï¼ˆäº†è§£æ›´å¤šï¼‰ï¼š
  x: 1667, y: 843, width: 833, height: 843
```

#### æœƒå“¡é¸å–®å€åŸŸé…ç½®

```
å·¦ä¸Šå€åŸŸï¼ˆæ–°å¢è¨‚å–®ï¼‰ï¼š
  x: 0, y: 0, width: 833, height: 562

ä¸­ä¸Šå€åŸŸï¼ˆæœƒå“¡ä¸­å¿ƒï¼‰ï¼š
  x: 834, y: 0, width: 834, height: 562

å³ä¸Šå€åŸŸï¼ˆæˆ‘çš„è¨‚å–®ï¼‰ï¼š
  x: 1667, y: 0, width: 833, height: 562

ä¸‹æ–¹ä¸‰å€‹å€åŸŸèˆ‡è¨ªå®¢é¸å–®ç›¸åŒ
```

### è¨­è¨ˆå»ºè­°

1. **è¦–è¦ºæ¸…æ™°åº¦**
   - ä½¿ç”¨å°æ¯”è‰²å€åˆ†ä¸åŒå€åŸŸ
   - åœ–ç¤ºå¤§å°é©ä¸­ï¼Œæ˜“æ–¼è¾¨è­˜
   - æ–‡å­—æ¸…æ™°å¯è®€ï¼ˆå»ºè­°å­—é«”å¤§å° > 40pxï¼‰

2. **å“ç‰Œä¸€è‡´æ€§**
   - ä½¿ç”¨çµ±ä¸€çš„é¡è‰²é…ç½®
   - ä¿æŒåœ–ç¤ºé¢¨æ ¼ä¸€è‡´
   - èˆ‡ LINE Bot ä¸»é¡Œé…åˆ

3. **å¯é»æ“Šæç¤º**
   - æ˜ç¢ºæ¨™ç¤ºå¯é»æ“Šå€åŸŸ
   - ä½¿ç”¨æŒ‰éˆ•æ¨£å¼è¨­è¨ˆ
   - é¿å…éåº¦è¤‡é›œçš„åœ–æ¡ˆ

4. **Loading é¸å–®ç‰¹æ®Šè€ƒé‡**
   - ä½¿ç”¨å‹•ç•«æ•ˆæœåœ–ç¤ºï¼ˆå¦‚æ—‹è½‰åœˆï¼‰
   - ç°¡æ½”æ˜ç­çš„ã€Œè™•ç†ä¸­ã€è¨Šæ¯
   - æŸ”å’Œçš„èƒŒæ™¯è‰²ï¼Œé¿å…åˆºçœ¼

### æ¨è–¦å·¥å…·

- **Figma** - å…è²»ç·šä¸Šè¨­è¨ˆå·¥å…·
- **Canva** - ç°¡æ˜“åœ–ç‰‡ç·¨è¼¯
- **Adobe Photoshop** - å°ˆæ¥­åœ–ç‰‡ç·¨è¼¯
- **LINE Rich Menu Generator** - LINE å®˜æ–¹è¨­è¨ˆå·¥å…·

---

## âš™ï¸ é¸å–®é…ç½®èªªæ˜

### è¨ªå®¢é¸å–®ç¨‹å¼ç¢¼èªªæ˜

```javascript
const richMenu = {
  size: {
    width: 2500,
    height: 1686
  },
  selected: true,              // æ˜¯å¦é è¨­é¸ä¸­
  name: 'è¨ªå®¢é¸å–®',            // é¸å–®åç¨±ï¼ˆå¾Œå°é¡¯ç¤ºï¼‰
  chatBarText: 'åŠŸèƒ½é¸å–®',     // èŠå¤©æ¬„é¡¯ç¤ºæ–‡å­—
  areas: [
    // è¨‚å–®ç®¡ç† - éœ€è¦ç™»å…¥
    {
      bounds: { x: 0, y: 0, width: 2500, height: 843 },
      action: {
        type: 'postback',
        data: `action=login_required&feature=orders&message=${encodeURIComponent('ğŸ”’ è¨‚å–®åŠŸèƒ½éœ€è¦å…ˆç™»å…¥æœƒå“¡å¸³è™Ÿ')}`
      }
    },
    // è—¥å¸«è«®è©¢
    {
      bounds: { x: 0, y: 843, width: 833, height: 843 },
      action: {
        type: 'postback',
        data: 'action=pharmacist_consultation'
      }
    },
    // ... å…¶ä»–å€åŸŸ
  ]
};
```

### Postback Action èªªæ˜

æ¯å€‹å¯é»æ“Šå€åŸŸéƒ½æœƒè§¸ç™¼ Postback äº‹ä»¶ï¼š

| Action | èªªæ˜ | è™•ç†ä½ç½® |
|--------|------|---------|
| `action=login_required` | æç¤ºéœ€è¦ç™»å…¥ | `postbackHandler.ts` |
| `action=pharmacist_consultation` | è—¥å¸«è«®è©¢ | `postbackHandler.ts` |
| `action=herbal_news` | ä¸­è—¥æ–°çŸ¥ | `postbackHandler.ts` |
| `action=tutorial` | ä½¿ç”¨æ•™å­¸ | `postbackHandler.ts` |
| `action=create_order` | æ–°å¢è¨‚å–® | `orderHandler.ts` |
| `action=view_orders` | æŸ¥çœ‹è¨‚å–® | `orderHandler.ts` |
| `action=member_center` | æœƒå“¡ä¸­å¿ƒ | `postbackHandler.ts` |

### é¸å–®åˆ‡æ›é‚è¼¯

åœ–æ–‡é¸å–®æœƒåœ¨ä»¥ä¸‹æƒ…æ³è‡ªå‹•åˆ‡æ›ï¼š

```javascript
// ç™»å…¥æˆåŠŸ â†’ åˆ‡æ›åˆ°æœƒå“¡é¸å–®
await client.linkRichMenuToUser(userId, MEMBER_RICH_MENU_ID);

// ç™»å‡º â†’ åˆ‡æ›åˆ°è¨ªå®¢é¸å–®
await client.linkRichMenuToUser(userId, GUEST_RICH_MENU_ID);

// åŸ·è¡Œè€—æ™‚æ“ä½œ â†’ åˆ‡æ›åˆ° Loading é¸å–®
await client.linkRichMenuToUser(userId, LOADING_RICH_MENU_ID);

// æ“ä½œå®Œæˆ â†’ æ¢å¾©åˆ°åŸé¸å–®
const isLoggedIn = await checkUserLoginStatus(userId);
const menuId = isLoggedIn ? MEMBER_RICH_MENU_ID : GUEST_RICH_MENU_ID;
await client.linkRichMenuToUser(userId, menuId);
```

---

## ğŸ”§ ç–‘é›£æ’è§£

### å•é¡Œ 1ï¼š403 Forbidden éŒ¯èª¤

**éŒ¯èª¤è¨Šæ¯ï¼š**
```
âŒ å»ºç«‹è¨ªå®¢åœ–æ–‡é¸å–®å¤±æ•—: Error: 403 Forbidden
```

**å¯èƒ½åŸå› ï¼š**
- LINE Channel Access Token ä¸æ­£ç¢º
- Bot æ²’æœ‰å»ºç«‹åœ–æ–‡é¸å–®çš„æ¬Šé™

**è§£æ±ºæ–¹æ³•ï¼š**
1. æª¢æŸ¥ `.env` æª”æ¡ˆä¸­çš„ `LINE_CHANNEL_ACCESS_TOKEN`
2. å‰å¾€ [LINE Developers Console](https://developers.line.biz/)
3. ç¢ºèª Token æ˜¯å¦æ­£ç¢º
4. é‡æ–°ç™¼è¡Œ Token ä¸¦æ›´æ–° `.env`

```bash
# é‡æ–°è¨­å®šç’°å¢ƒè®Šæ•¸
cp .env.example .env
# ç·¨è¼¯ .envï¼Œå¡«å…¥æ­£ç¢ºçš„ Token
```

---

### å•é¡Œ 2ï¼š400 Bad Request - åœ–ç‰‡ç›¸é—œéŒ¯èª¤

**éŒ¯èª¤è¨Šæ¯ï¼š**
```
âŒ å»ºç«‹è¨ªå®¢åœ–æ–‡é¸å–®å¤±æ•—: Error: 400 Bad Request
```

**å¯èƒ½åŸå› ï¼š**
- åœ–ç‰‡æª”æ¡ˆä¸å­˜åœ¨
- åœ–ç‰‡å°ºå¯¸ä¸æ­£ç¢ºï¼ˆå¿…é ˆæ˜¯ 2500x1686ï¼‰
- åœ–ç‰‡æ ¼å¼ä¸æ”¯æ´

**è§£æ±ºæ–¹æ³•ï¼š**

1. **æª¢æŸ¥åœ–ç‰‡æ˜¯å¦å­˜åœ¨ï¼š**
```bash
ls -lh public/*.png
```

2. **æª¢æŸ¥åœ–ç‰‡å°ºå¯¸ï¼š**
```bash
# macOS
sips -g pixelWidth -g pixelHeight public/guest_richmenu.png

# æ‡‰è©²é¡¯ç¤ºï¼š
# pixelWidth: 2500
# pixelHeight: 1686
```

3. **èª¿æ•´åœ–ç‰‡å°ºå¯¸ï¼š**
```bash
# ä½¿ç”¨ ImageMagickï¼ˆéœ€å…ˆå®‰è£ï¼‰
convert input.png -resize 2500x1686! public/guest_richmenu.png
```

---

### å•é¡Œ 3ï¼šåœ–ç‰‡æª”æ¡ˆä¸å­˜åœ¨è­¦å‘Š

**è­¦å‘Šè¨Šæ¯ï¼š**
```
âš ï¸  è¨ªå®¢åœ–æ–‡é¸å–®åœ–ç‰‡æª”æ¡ˆä¸å­˜åœ¨: /path/to/public/guest_richmenu.png
```

**è§£æ±ºæ–¹æ³•ï¼š**

1. **ç¢ºèªæª”æ¡ˆä½ç½®ï¼š**
```bash
# æª¢æŸ¥ public è³‡æ–™å¤¾
ls -la public/

# æ‡‰è©²æœ‰é€™äº›æª”æ¡ˆï¼š
# guest_richmenu.png
# member_richmenu.png
# loading_richmenu.png
```

2. **ä¸‹è¼‰ç¯„ä¾‹åœ–ç‰‡ï¼š**
å¦‚æœæ²’æœ‰åœ–ç‰‡ï¼Œå¯ä»¥å…ˆå»ºç«‹ç°¡å–®çš„æ¸¬è©¦åœ–ç‰‡ï¼š

```bash
# ä½¿ç”¨ ImageMagick å»ºç«‹æ¸¬è©¦åœ–ç‰‡
convert -size 2500x1686 xc:lightblue \
  -pointsize 100 -gravity center \
  -annotate +0+0 'è¨ªå®¢é¸å–®' \
  public/guest_richmenu.png

convert -size 2500x1686 xc:lightgreen \
  -pointsize 100 -gravity center \
  -annotate +0+0 'æœƒå“¡é¸å–®' \
  public/member_richmenu.png

convert -size 2500x1686 xc:lightyellow \
  -pointsize 100 -gravity center \
  -annotate +0+0 'Loading...' \
  public/loading_richmenu.png
```

---

### å•é¡Œ 4ï¼šé¸å–®æ²’æœ‰è‡ªå‹•åˆ‡æ›

**ç—‡ç‹€ï¼š**
- ç™»å…¥å¾Œé¸å–®æ²’æœ‰è®Šæ›´
- Loading é¸å–®æ²’æœ‰é¡¯ç¤º

**æª¢æŸ¥æ­¥é©Ÿï¼š**

1. **ç¢ºèªç’°å¢ƒè®Šæ•¸å·²è¨­å®šï¼š**
```bash
# æª¢æŸ¥ .env æª”æ¡ˆ
cat .env | grep RICH_MENU
```

æ‡‰è©²çœ‹åˆ°ï¼š
```
GUEST_RICH_MENU_ID=richmenu-xxx...
MEMBER_RICH_MENU_ID=richmenu-yyy...
LOADING_RICH_MENU_ID=richmenu-zzz...
```

2. **é‡æ–°å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ï¼š**
```bash
# åœæ­¢ç¾æœ‰ç¨‹åº
# é‡æ–°å•Ÿå‹•
npm run dev
```

3. **æª¢æŸ¥ç¨‹å¼ç¢¼ä¸­çš„é¸å–®åˆ‡æ›é‚è¼¯ï¼š**

æŸ¥çœ‹ `src/handlers/richMenuHandler.ts`ï¼š

```typescript
export async function switchToMemberMenu(userId: string) {
  const menuId = process.env.MEMBER_RICH_MENU_ID;
  if (!menuId) {
    console.error('MEMBER_RICH_MENU_ID not set in environment');
    return;
  }
  await client.linkRichMenuToUser(userId, menuId);
}
```

---

### å•é¡Œ 5ï¼šå·²ç¶“æœ‰èˆŠçš„åœ–æ–‡é¸å–®

**ç—‡ç‹€ï¼š**
```
ğŸ“‹ ç¾æœ‰çš„åœ–æ–‡é¸å–®:
1. ID: richmenu-old123...
   åç¨±: èˆŠé¸å–®
   ...
```

**è§£æ±ºæ–¹æ³•ï¼š**

**é¸é … Aï¼šä¿ç•™èˆŠé¸å–®ï¼Œä½¿ç”¨æ–°é¸å–®**
```bash
# ç›´æ¥å»ºç«‹æ–°é¸å–®ï¼ˆä¸å½±éŸ¿èˆŠçš„ï¼‰
npm run setup-menus

# æ›´æ–° .env ä½¿ç”¨æ–°çš„ ID
```

**é¸é … Bï¼šåˆªé™¤èˆŠé¸å–®**
```bash
# ä½¿ç”¨äº’å‹•å¼å·¥å…·
npm run manage-menus

# é¸æ“‡ï¼š3. åˆªé™¤æŒ‡å®šåœ–æ–‡é¸å–®
# è¼¸å…¥èˆŠé¸å–®çš„ ID

# ç„¶å¾Œå»ºç«‹æ–°é¸å–®
# é¸æ“‡ï¼š4. å»ºç«‹å®Œæ•´çš„é¸å–®çµ„åˆ
```

**é¸é … Cï¼šä½¿ç”¨æŒ‡ä»¤ç¢¼æ‰¹æ¬¡æ¸…ç†**
```bash
# ä½¿ç”¨æ¸…ç†è…³æœ¬
node scripts/cleanup-rich-menus.js
```

---

### å•é¡Œ 6ï¼šLINE API é™åˆ¶éŒ¯èª¤

**éŒ¯èª¤è¨Šæ¯ï¼š**
```
âŒ Error: 429 Too Many Requests
```

**åŸå› ï¼š**
LINE API æœ‰é€Ÿç‡é™åˆ¶

**è§£æ±ºæ–¹æ³•ï¼š**
1. ç­‰å¾…å¹¾åˆ†é˜å¾Œå†è©¦
2. é¿å…çŸ­æ™‚é–“å…§é »ç¹å»ºç«‹/åˆªé™¤é¸å–®
3. ä½¿ç”¨ Loading Rich Menu æ¸›å°‘ pushMessage èª¿ç”¨

---

## ğŸ“ é€²éšç®¡ç†

### åˆ—å‡ºæ‰€æœ‰åœ–æ–‡é¸å–®

```bash
npm run manage-menus
# é¸æ“‡é¸é … 1
```

æˆ–ç›´æ¥ä½¿ç”¨ç¨‹å¼ç¢¼ï¼š

```javascript
const { Client } = require('@line/bot-sdk');

const client = new Client({
  channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN
});

const richMenus = await client.getRichMenuList();
console.log(richMenus);
```

---

### å–å¾—ç‰¹å®šç”¨æˆ¶çš„åœ–æ–‡é¸å–®

```javascript
const richMenuId = await client.getRichMenuIdOfUser(userId);
console.log('ç”¨æˆ¶ç•¶å‰ä½¿ç”¨çš„åœ–æ–‡é¸å–® ID:', richMenuId);
```

---

### æ‰‹å‹•åˆ‡æ›ç”¨æˆ¶çš„åœ–æ–‡é¸å–®

```javascript
// åˆ‡æ›åˆ°æœƒå“¡é¸å–®
await client.linkRichMenuToUser(userId, process.env.MEMBER_RICH_MENU_ID);

// åˆ‡æ›åˆ°è¨ªå®¢é¸å–®
await client.linkRichMenuToUser(userId, process.env.GUEST_RICH_MENU_ID);

// å–æ¶ˆåœ–æ–‡é¸å–®é€£çµ
await client.unlinkRichMenuFromUser(userId);
```

---

### æ‰¹æ¬¡è¨­å®šé è¨­åœ–æ–‡é¸å–®

å¦‚æœæƒ³è®“æ‰€æœ‰æ–°ç”¨æˆ¶é è¨­ä½¿ç”¨è¨ªå®¢é¸å–®ï¼š

```javascript
// è¨­å®šé è¨­åœ–æ–‡é¸å–®ï¼ˆæ‰€æœ‰æ–°ç”¨æˆ¶æœƒè‡ªå‹•ä½¿ç”¨ï¼‰
await client.setDefaultRichMenu(process.env.GUEST_RICH_MENU_ID);

// å–æ¶ˆé è¨­åœ–æ–‡é¸å–®
await client.cancelDefaultRichMenu();
```

**æ³¨æ„ï¼š** é€šå¸¸æˆ‘å€‘åœ¨ `followHandler.ts` ä¸­è™•ç†æ–°ç”¨æˆ¶ï¼Œæ‰‹å‹•è¨­å®šè¨ªå®¢é¸å–®ï¼Œè€Œä¸æ˜¯ä½¿ç”¨é è¨­é¸å–®åŠŸèƒ½ã€‚

---

### æ›´æ–°åœ–æ–‡é¸å–®åœ–ç‰‡

å¦‚æœè¦æ›´æ–°åœ–ç‰‡ä½†ä¿ç•™é¸å–®è¨­å®šï¼š

```bash
# 1. æº–å‚™æ–°åœ–ç‰‡ï¼ˆæ”¾åœ¨ public/ è³‡æ–™å¤¾ï¼‰
# 2. åŸ·è¡Œæ›´æ–°è…³æœ¬

node scripts/refresh-rich-menus.js
```

æˆ–æ‰‹å‹•æ›´æ–°ï¼š

```javascript
const fs = require('fs');
const path = require('path');

const imageBuffer = fs.readFileSync('public/new_guest_richmenu.png');
await client.setRichMenuImage(
  process.env.GUEST_RICH_MENU_ID,
  imageBuffer,
  'image/png'
);
```

---

### ç›£æ§åœ–æ–‡é¸å–®ä½¿ç”¨ç‹€æ³

å»ºè­°å®šæœŸæª¢æŸ¥åœ–æ–‡é¸å–®çš„ä½¿ç”¨ç‹€æ³ï¼š

```javascript
// åœ¨ webhook handler ä¸­åŠ å…¥ logging
console.log('Postback Event:', {
  userId,
  data: event.postback.data,
  richMenuId: await client.getRichMenuIdOfUser(userId)
});
```

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [LINE Messaging API - Rich Menu å®˜æ–¹æ–‡ä»¶](https://developers.line.biz/en/docs/messaging-api/using-rich-menus/)
- [DEVELOPMENT.md](./DEVELOPMENT.md) - æœ¬åœ°é–‹ç™¼æŒ‡å—
- [README-loading-menu.md](./README-loading-menu.md) - Loading é¸å–®è©³ç´°èªªæ˜
- [scripts/README.md](../scripts/README.md) - è…³æœ¬å·¥å…·èªªæ˜

---

## âœ… æª¢æŸ¥æ¸…å–®

è¨­å®šå®Œæˆå¾Œï¼Œè«‹ç¢ºèªä»¥ä¸‹é …ç›®ï¼š

- [ ] `.env` æª”æ¡ˆä¸­æœ‰ `GUEST_RICH_MENU_ID`
- [ ] `.env` æª”æ¡ˆä¸­æœ‰ `MEMBER_RICH_MENU_ID`
- [ ] `.env` æª”æ¡ˆä¸­æœ‰ `LOADING_RICH_MENU_ID`
- [ ] åœ–ç‰‡æª”æ¡ˆéƒ½å·²ä¸Šå‚³åˆ° LINE
- [ ] æ‡‰ç”¨ç¨‹å¼å·²é‡æ–°å•Ÿå‹•
- [ ] åœ¨ LINE ä¸­å¯ä»¥çœ‹åˆ°åœ–æ–‡é¸å–®
- [ ] é»æ“Šè¨ªå®¢é¸å–®çš„å„å€‹æŒ‰éˆ•éƒ½æœ‰åæ‡‰
- [ ] ç™»å…¥å¾Œé¸å–®æœƒåˆ‡æ›åˆ°æœƒå“¡é¸å–®
- [ ] ç™»å‡ºå¾Œé¸å–®æœƒåˆ‡æ›å›è¨ªå®¢é¸å–®
- [ ] åŸ·è¡Œè€—æ™‚æ“ä½œæ™‚æœƒé¡¯ç¤º Loading é¸å–®
- [ ] Loading å®Œæˆå¾Œæœƒè‡ªå‹•æ¢å¾©æ­£å¸¸é¸å–®

---

## ğŸ‰ å®Œæˆï¼

æ­å–œï¼ä½ å·²ç¶“å®Œæˆ LINE Bot åœ–æ–‡é¸å–®çš„è¨­å®šã€‚

**ä¸‹ä¸€æ­¥ï¼š**
- æ¸¬è©¦æ‰€æœ‰åŠŸèƒ½æŒ‰éˆ•
- æ ¹æ“šéœ€æ±‚èª¿æ•´é¸å–®é…ç½®
- è¨­è¨ˆæ›´ç²¾ç¾çš„åœ–æ–‡é¸å–®åœ–ç‰‡
- åƒè€ƒ [DEVELOPMENT.md](./DEVELOPMENT.md) ç¹¼çºŒé–‹ç™¼å…¶ä»–åŠŸèƒ½

**éœ€è¦å”åŠ©ï¼Ÿ**
- æŸ¥çœ‹ [ç–‘é›£æ’è§£](#ç–‘é›£æ’è§£) ç« ç¯€
- æª¢æŸ¥ LINE Developers Console çš„éŒ¯èª¤æ—¥èªŒ
- åƒè€ƒ LINE å®˜æ–¹æ–‡ä»¶
